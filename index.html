<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>내곁에북클럽 – Daily Reading Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      color-scheme: light dark;
    }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",sans-serif;
      background: #f5f5f7;
      color: #111827;
    }
    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
      box-sizing: border-box;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.8rem;
    }
    .logo {
      font-weight: 700;
      font-size: 1.2rem;
    }
    .logo span {
      font-weight: 400;
      font-size: 0.8rem;
      color: #6b7280;
      display: block;
    }
    .user-chip {
      font-size: 0.8rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .user-chip button {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 0;
    }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.8rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.4rem;
    }
    .tab {
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
    }
    .tab.active {
      background: #111827;
      color: #f9fafb;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 1rem 1.1rem;
      margin-bottom: 0.9rem;
      box-shadow: 0 1px 4px rgba(15,23,42,0.06);
      border: 1px solid #e5e7eb;
    }
    h2 {
      font-size: 1rem;
      margin: 0 0 0.4rem;
    }
    .subtitle {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 0.7rem;
    }
    label {
      font-size: 0.8rem;
      display: block;
      margin: 0.5rem 0 0.15rem;
      color: #374151;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="date"],
    textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 0.45rem 0.6rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: #f9fafb;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .row > div {
      flex: 1 1 180px;
    }
    button.primary {
      margin-top: 0.9rem;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 0.6rem 1rem;
      font-size: 0.95rem;
      font-weight: 600;
      background: #111827;
      color: #f9fafb;
      cursor: pointer;
    }
    #quoteInput {min-height: 200px;
    }
    #reflectionInput {min-height: 200px;
    }
    #caseGoodInput {min-height: 150px;
    }
    #caseBadInput {min-height: 150px;
    }
    #caseLessonInput {min-height: 150px;
    }
    button.primary:active {
      opacity: 0.85;
    }
    .muted {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .logs-list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 0.3rem;
    }
    .log-item {
      padding: 0.6rem 0.7rem;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .log-head {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.8rem;
      margin-bottom: 0.3rem;
      color: #6b7280;
    }
    .log-mainline {
      font-size: 0.85rem;
      font-weight: 600;
      color: #111827;
    }
    .log-quote {
      margin-top: 0.2rem;
      font-size: 0.85rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.5rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 0.75rem;
    }
    .section-hidden {
      display: none;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.6rem;
      margin-top: 0.6rem;
    }
    .stat-card {
      padding: 0.6rem 0.7rem;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.85rem;
    }
    .stat-label {
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 0.3rem;
    }
    .stat-value {
      font-size: 1rem;
      font-weight: 600;
    }
    .mini-list {
      margin: 0.4rem 0 0;
      padding-left: 1rem;
      font-size: 0.8rem;
    }
    .mini-list li {
      margin-bottom: 0.1rem;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background: #020617;
        color: #e5e7eb;
      }
      .card {
        background: #020617;
        border-color: #1f2937;
        box-shadow: 0 1px 4px rgba(0,0,0,0.7);
      }
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="date"],
      textarea {
        background: #020617;
        border-color: #1f2937;
        color: #e5e7eb;
      }
      .log-item,
      .stat-card {
        background: #020617;
        border-color: #1f2937;
      }
      .user-chip {
        background: #e5e7eb;
        color: #020617;
      }
      button.primary {
        background: #e5e7eb;
        color: #020617;
      }
      .tabs {
        border-color: #1f2937;
      }
      .tab {
        background: #111827;
        color: #e5e7eb;
      }
      .tab.active {
        background: #e5e7eb;
        color: #020617;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo">
        내곁에북클럽
        <span id="headerBookLabel">Lessons from the Titans · Daily Reading</span>
      </div>
      <div id="userArea"></div>
    </header>

    <main id="content"></main>
  </div>

  <script>
    // ✅ 여기에 Supabase 프로젝트 정보만 채워 넣으면 됩니다.
    const SUPABASE_URL = "https://mpmjjkosxhnffwymspru.supabase.co";      // TODO: 교체
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wbWpqa29zeGhuZmZ3eW1zcHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNDQwMDIsImV4cCI6MjA4MDcyMDAwMn0.MAauyc4e459U6YVh4TTSL3PF1HO-mQGb4ujHEKKfqjY";                // TODO: 교체

    const DEFAULT_BOOK_TITLE = "Lessons from the Titans";
    const ADMIN_EMAILS = ["lyngw@naver.com"];   // 필요시 이메일 추가

    let currentBookTitle = DEFAULT_BOOK_TITLE;
    let currentSeason = null; // { name, start, end }

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function todayISO() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    
    async function getSession() {
      const { data } = await supabase.auth.getSession();
      return data.session;
    }

    async function loadClubSettings() {
      try {
        const { data, error } = await supabase
          .from("club_settings")
          .select("key, value");

        currentBookTitle = DEFAULT_BOOK_TITLE;
        currentSeason = null;

        if (!error && data) {
          data.forEach(row => {
            if (row.key === "current_book" && row.value && row.value.title) {
              currentBookTitle = row.value.title;
            }
            if (row.key === "season" && row.value) {
              currentSeason = row.value;
            }
          });
        }
      } catch (e) {
        console.error("클럽 설정 불러오기 오류:", e);
      }

      // 헤더 라벨 업데이트
      const headerLabel = document.getElementById("headerBookLabel");
      if (headerLabel) {
        headerLabel.textContent = `${currentBookTitle} · Daily Reading`;
      }
    }

    function renderLogin(mode) {
      const root = document.getElementById("content");
      const userArea = document.getElementById("userArea");
      userArea.innerHTML = "";

      const isLogin = mode !== "signup";

      root.innerHTML = `
        <section class="card">
          <h2>${isLogin ? "로그인" : "회원가입"}</h2>
          <div class="subtitle">
            내곁에북클럽 계정으로 ${isLogin ? "접속해 오늘의 독서 기록을 남겨보세요." : "가입 후 매일 읽은 내용을 기록할 수 있어요."}
          </div>
          
          ${isLogin ? "" : `
          <label for="displayName">이름 / 닉네임</label>
          <input id="displayName" type="text" placeholder="내곁에서재" />
          `}
          
          ${isLogin ? `<button class="primary" id="kakaoLoginBtn" ...>카카오로 로그인</button>` : ""}
          <div class="login-toggle">
            ${isLogin
              ? `<span class="muted">아직 계정이 없나요?</span><button id="goSignup">회원가입</button>`
              : `<span class="muted">이미 계정이 있나요?</span><button id="goLogin">로그인</button>`
            }
          </div>
        </section>
      `;

      document.getElementById("submitAuthBtn").onclick = () => handleAuth(isLogin ? "login" : "signup");
      const goSignup = document.getElementById("goSignup");
      const goLogin = document.getElementById("goLogin");
      if (goSignup) goSignup.onclick = () => renderLogin("signup");
      if (goLogin) goLogin.onclick = () => renderLogin("login");

      const kakaoBtn = document.getElementById("kakaoLoginBtn");
      if (kakaoBtn) {
        kakaoBtn.onclick = async () => {
          await supabase.auth.signInWithOAuth({
            provider: "kakao",
            options: { redirectTo: "https://lyngw.github.io/bookclub/" }
          });
        };
      }
    }

    async function handleAuth(mode) {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) {
        alert("이메일과 비밀번호를 입력해 주세요.");
        return;
      }

      if (mode === "signup") {
        const displayName = document.getElementById("displayName").value.trim();
        if (!displayName) {
          alert("이름 또는 닉네임도 입력해 주세요.");
          return;
        }
        const { data, error } = await supabase.auth.signUp({
          email,
          password
        });
        if (error) {
          alert("회원가입 실패: " + error.message);
          return;
        }
        const user = data.user;
        if (user) {
          await supabase.from("profiles").insert({
            id: user.id,
            display_name: displayName
          }).catch(() => {});
        }
        alert("회원가입이 완료되었습니다. 다시 로그인해 주세요.");
        renderLogin("login");
        return;
      }

      if (mode === "login") {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        if (error) {
          alert("로그인 실패: " + error.message);
          return;
        }
        const session = data.session;
        renderApp(session.user);
      }
    }

    function setupTabs() {
      const tabs = Array.from(document.querySelectorAll(".tab"));
      const sections = Array.from(document.querySelectorAll("[data-section]"));

      function activate(name) {
        tabs.forEach(tab => {
          if (tab.dataset.tab === name) tab.classList.add("active");
          else tab.classList.remove("active");
        });
        sections.forEach(sec => {
          if (sec.dataset.section === name) sec.classList.remove("section-hidden");
          else sec.classList.add("section-hidden");
        });
      }

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          activate(tab.dataset.tab);
        });
      });

      activate("today");
    }

    async function renderApp(user) {
      const userArea = document.getElementById("userArea");
      const root = document.getElementById("content");
      const isAdmin = ADMIN_EMAILS.includes(user.email);

      // 프로필 불러오기
      let displayName = "";
      const { data: profileRows } = await supabase
        .from("profiles")
        .select("display_name")
        .eq("id", user.id)
        .maybeSingle();
      if (profileRows && profileRows.display_name) {
        displayName = profileRows.display_name;
      } else {
        displayName = user.email;
      }

      userArea.innerHTML = `
        <div class="user-chip">
          <span id="headerDisplayName">${displayName}</span>
          <button id="logoutBtn">로그아웃</button>
        </div>
      `;
      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        renderLogin("login");
      };

      root.innerHTML = `
        <nav class="tabs">
          <button class="tab" data-tab="profile">프로필</button>
          <button class="tab" data-tab="today">오늘의 독서 기록</button>
          <button class="tab" data-tab="logs">기록 보기</button>
          <button class="tab" data-tab="case">케이스 분석 하기</button>
          <button class="tab" data-tab="dashboard">클럽 대시보드</button>
          ${isAdmin ? `<button class="tab" data-tab="settings">클럽 설정</button>` : ""}
        </nav>

        <section class="card" data-section="profile" id="profileSection">
          <h2>내 프로필</h2>
          <div class="subtitle">클럽에서 보이는 이름(닉네임)을 바꿀 수 있어요.</div>
          <label>현재 닉네임</label>
          <input id="nicknameInput" type="text" />
          <button class="primary" id="saveNicknameBtn">닉네임 저장</button>
          <div class="muted" id="nicknameStatus"></div>
        </section>

        <section class="card" data-section="today" id="todaySection">
          <h2>오늘의 독서 기록</h2>
          <div class="subtitle">
            오늘 <span id="currentBookLabel"></span>에서 읽은 내용을 정리해 보세요. (자동으로 오늘 날짜로 저장됩니다.)
          </div>
          <div class="row">
            <div>
              <label>읽은 범위 (챕터 / 페이지)</label>
              <input id="sectionInput" type="text" placeholder="예: Chapter 3 · p.45–70" />
            </div>
            <div>
              <label>날짜</label>
              <input id="dateInput" type="text" disabled />
            </div>
          </div>
          <label>오늘의 핵심 포인트</label>
          <textarea id="keyPointsInput" placeholder="핵심 문장 2~3줄로 요약해 보세요."></textarea>
          <label>오늘의 한 문장 (인상 깊었던 문장)</label>
          <textarea id="quoteInput" placeholder="원문 그대로 옮겨 적어도, 요약해 적어도 좋아요."></textarea>
          <label>느낀 점 / 적용 아이디어</label>
          <textarea id="reflectionInput" placeholder="오늘 이 기업 사례에서 내가 배운 점, 나의 삶/일에 적용할 부분을 적어보세요."></textarea>
          <button class="primary" id="saveTodayBtn">오늘 기록 저장</button>
          <div class="muted" id="saveStatus"></div>
        </section>

        <section data-section="logs" id="logsSection">
          <section class="card" id="recentCard">
            <h2>나의 최근 기록</h2>
            <div class="subtitle">최근 일주일 동안의 내 독서 기록을 모아봤어요.</div>
            <div id="logsList" class="logs-list"></div>
          </section>

          <section class="card" id="clubCard">
            <h2>클럽의 최근 기록</h2>
            <div class="subtitle">멤버들이 남긴 최근 기록 20개를 함께 살펴봐요.</div>
            <div id="clubLogsList" class="logs-list"></div>
          </section>
        </section>

        <section class="card" data-section="case" id="caseSection">
          <h2>케이스 분석 하기</h2>
          <div class="subtitle">
            <span id="caseBookLabel"></span>의 기업 사례를 MBA 케이스 스터디처럼 정리해 보세요.
          </div>
          <label>기업 이름 / 티커</label>
          <input id="caseCompanyInput" type="text" placeholder="예: GE, Boeing, GM..." />
          <label>읽은 범위 (챕터 / 페이지)</label>
          <input id="caseSectionInput" type="text" placeholder="예: Chapter 4 · p.120–150" />
          <label>한 줄 요약 (이 케이스의 핵심)</label>
          <textarea id="caseSummaryInput" placeholder="이 케이스는 결국 무엇에 대한 이야기인가요?"></textarea>
          <label>무엇이 잘 되었나? (Strengths / 성공 요인)</label>
          <textarea id="caseGoodInput" placeholder="기업/경영진이 잘한 점, 운이 좋았던 부분 등"></textarea>
          <label>무엇이 잘 안 되었나? (Weaknesses / 실패 요인)</label>
          <textarea id="caseBadInput" placeholder="전략적 실수, 구조적 한계, 외부 환경 등"></textarea>
          <label>전략적 인사이트 (Strategy Insight)</label>
          <textarea id="caseLessonInput" placeholder="이 사례를 통해 배운 전략 원칙, 프레임워크, 통찰"></textarea>
          <label>나의 적용 아이디어</label>
          <textarea id="caseActionInput" placeholder="내 삶/일/비즈니스에 어떻게 적용할 수 있을까요?"></textarea>
          <button class="primary" id="saveCaseBtn">케이스 분석 저장</button>
          <div class="muted" id="caseStatus"></div>

          <div style="margin-top:0.9rem;">
            <h2 style="margin-top:0.2rem;">내가 쓴 케이스들</h2>
            <div class="subtitle">최근에 정리한 케이스 분석 몇 개를 다시 볼 수 있어요.</div>
            <div id="caseList" class="logs-list"></div>
          </div>
        </section>

        <section class="card" data-section="dashboard" id="dashboardSection">
          <h2>클럽 대시보드</h2>
          <div class="subtitle">
            <span id="dashboardBookLabel"></span> 기준 활동 요약입니다.
            <span id="seasonLabel" class="muted"></span>
          </div>
          <div id="dashboardContent">
            <div class="muted">데이터를 불러오는 중...</div>
          </div>
        </section>

        ${isAdmin ? `
        <section class="card" data-section="settings" id="settingsSection">
          <h2>클럽 설정</h2>
          <div class="subtitle">
            북클럽에서 함께 읽는 책과 시즌(기간)을 설정할 수 있어요. 설정은 모든 멤버에게 바로 반영됩니다.
          </div>
          <label>현재 책 제목</label>
          <input id="settingBookTitleInput" type="text" placeholder="Lessons from the Titans" />
          <label>시즌 이름 (선택)</label>
          <input id="settingSeasonNameInput" type="text" placeholder="예: 1기 · Titans 12월" />
          <div class="row">
            <div>
              <label>시즌 시작일</label>
              <input id="settingSeasonStartInput" type="date" />
            </div>
            <div>
              <label>시즌 종료일</label>
              <input id="settingSeasonEndInput" type="date" />
            </div>
          </div>
          <button class="primary" id="saveSettingsBtn">클럽 설정 저장</button>
          <div class="muted" id="settingsStatus"></div>
        </section>
        ` : ""}
      `;

      // 텍스트 라벨 세팅
      const bookLabel = document.getElementById("currentBookLabel");
      if (bookLabel) bookLabel.textContent = currentBookTitle;
      const caseBookLabel = document.getElementById("caseBookLabel");
      if (caseBookLabel) caseBookLabel.textContent = currentBookTitle;
      const dashBookLabel = document.getElementById("dashboardBookLabel");
      if (dashBookLabel) dashBookLabel.textContent = currentBookTitle;

      if (currentSeason && currentSeason.name) {
        const seasonLabel = document.getElementById("seasonLabel");
        if (seasonLabel) {
          const start = currentSeason.start || "";
          const end = currentSeason.end || "";
          seasonLabel.textContent = ` · 시즌: ${currentSeason.name} (${start} ~ ${end})`;
        }
      }

      // 프로필/닉네임
      document.getElementById("nicknameInput").value = displayName;
      document.getElementById("saveNicknameBtn").onclick = () => saveNickname(user);

      // 오늘 날짜 세팅
      document.getElementById("dateInput").value = todayISO();
      document.getElementById("saveTodayBtn").onclick = () => saveTodayLog(user);

      // 케이스/대시보드/설정 버튼 이벤트
      document.getElementById("saveCaseBtn").onclick = () => saveCase(user);
      if (isAdmin) {
        fillSettingsForm();
        document.getElementById("saveSettingsBtn").onclick = () => saveClubSettings(user);
      }

      setupTabs();
      loadTodayLog(user);
      loadRecentLogs(user);
      loadClubRecentLogs();
      loadCaseList(user);
      loadDashboard();
    }

    async function saveNickname(user) {
      const input = document.getElementById("nicknameInput");
      const statusEl = document.getElementById("nicknameStatus");
      const headerName = document.getElementById("headerDisplayName");
      const newName = (input.value || "").trim();

      if (!newName) {
        statusEl.textContent = "닉네임을 비울 수는 없습니다.";
        return;
      }

      const { error } = await supabase
        .from("profiles")
        .upsert({
          id: user.id,
          display_name: newName
        }, { onConflict: "id" });

      if (error) {
        console.error("닉네임 저장 오류:", error);
        statusEl.textContent = "닉네임 저장 중 오류가 발생했습니다.";
      } else {
        statusEl.textContent = "닉네임이 저장되었습니다.";
        if (headerName) headerName.textContent = newName;
        loadClubRecentLogs();
        loadDashboard();
      }
    }

    async function loadTodayLog(user) {
      const today = todayISO();
      const { data, error } = await supabase
        .from("reading_logs")
        .select("*")
        .eq("user_id", user.id)
        .eq("date", today)
        .eq("book_title", currentBookTitle)
        .maybeSingle();

      if (error && error.code !== "PGRST116") {
        console.error("오늘 기록 불러오기 오류:", error);
        return;
      }

      if (data) {
        document.getElementById("sectionInput").value = data.section || "";
        document.getElementById("keyPointsInput").value = data.key_points || "";
        document.getElementById("quoteInput").value = data.quote || "";
        document.getElementById("reflectionInput").value = data.reflection || "";
        document.getElementById("saveStatus").textContent = "이미 저장된 오늘의 기록을 불러왔습니다.";
      } else {
        document.getElementById("saveStatus").textContent = "아직 오늘의 기록이 없습니다. 새로 작성해 보세요.";
      }
    }

    async function saveTodayLog(user) {
      const date = todayISO();
      const section = document.getElementById("sectionInput").value.trim();
      const keyPoints = document.getElementById("keyPointsInput").value.trim();
      const quote = document.getElementById("quoteInput").value.trim();
      const reflection = document.getElementById("reflectionInput").value.trim();
      const statusEl = document.getElementById("saveStatus");

      const payload = {
        user_id: user.id,
        date,
        book_title: currentBookTitle,
        section,
        key_points: keyPoints,
        quote,
        reflection
      };

      const { error } = await supabase
        .from("reading_logs")
        .upsert(payload, {
          onConflict: "user_id,date,book_title"
        });

      if (error) {
        console.error("저장 오류:", error);
        statusEl.textContent = "저장 중 오류가 발생했습니다. 다시 시도해 주세요.";
      } else {
        statusEl.textContent = "오늘의 기록이 저장되었습니다.";
        loadRecentLogs(user);
        loadClubRecentLogs();
        loadDashboard();
      }
    }

    function formatDate(iso) {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        const m = d.getMonth() + 1;
        const day = d.getDate();
        return `${m}/${day}`;
      } catch {
        return iso;
      }
    }

    async function loadRecentLogs(user) {
      const { data, error } = await supabase
        .from("reading_logs")
        .select("*")
        .eq("user_id", user.id)
        .eq("book_title", currentBookTitle)
        .order("date", { ascending: false })
        .limit(7);

      const listEl = document.getElementById("logsList");
      if (!listEl) return;

      if (error) {
        console.error("최근 기록 불러오기 오류:", error);
        listEl.innerHTML = `<div class="muted">최근 기록을 불러오지 못했습니다.</div>`;
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = `<div class="muted">아직 저장된 기록이 없습니다.</div>`;
        return;
      }

      listEl.innerHTML = "";
      data.forEach(row => {
        const div = document.createElement("div");
        div.className = "log-item";
        div.innerHTML = `
          <div class="log-head">
            <span>${formatDate(row.date)} · ${currentBookTitle}</span>
            <span class="pill">${row.section || "범위 미기입"}</span>
          </div>
          <div class="log-mainline">${row.key_points || ""}</div>
          ${row.quote ? `<div class="log-quote"><span class="muted">오늘의 한 문장</span><br>${row.quote}</div>` : ""}
        `;
        div.title = row.reflection || "";
        listEl.appendChild(div);
      });
    }

    async function loadClubRecentLogs() {
      const listEl = document.getElementById("clubLogsList");
      if (!listEl) return;

      const { data: profiles, error: profileError } = await supabase
        .from("profiles")
        .select("id, display_name");
      if (profileError) {
        console.error("프로필 불러오기 오류:", profileError);
      }
      const nameMap = {};
      if (profiles) {
        profiles.forEach(p => {
          nameMap[p.id] = p.display_name || "";
        });
      }

      const { data, error } = await supabase
        .from("reading_logs")
        .select("*")
        .eq("book_title", currentBookTitle)
        .order("date", { ascending: false })
        .limit(50);

      if (error) {
        console.error("클럽 기록 불러오기 오류:", error);
        listEl.innerHTML = `<div class="muted">클럽 기록을 불러오지 못했습니다.</div>`;
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = `<div class="muted">아직 저장된 클럽 기록이 없습니다.</div>`;
        return;
      }

      listEl.innerHTML = "";
      data.forEach(row => {
        const div = document.createElement("div");
        div.className = "log-item";
        const displayName = nameMap[row.user_id] || "익명 멤버";
        div.innerHTML = `
          <div class="log-head">
            <span>${formatDate(row.date)} · ${displayName}</span>
            <span class="pill">${row.section || "범위 미기입"}</span>
          </div>
          <div class="log-mainline">${row.key_points || ""}</div>
          ${row.quote ? `<div class="log-quote"><span class="muted">오늘의 한 문장</span><br>${row.quote}</div>` : ""}
        `;
        div.title = row.reflection || "";
        listEl.appendChild(div);
      });
    }

    async function saveCase(user) {
      const company = document.getElementById("caseCompanyInput").value.trim();
      const section = document.getElementById("caseSectionInput").value.trim();
      const summary = document.getElementById("caseSummaryInput").value.trim();
      const good = document.getElementById("caseGoodInput").value.trim();
      const bad = document.getElementById("caseBadInput").value.trim();
      const lesson = document.getElementById("caseLessonInput").value.trim();
      const action = document.getElementById("caseActionInput").value.trim();
      const statusEl = document.getElementById("caseStatus");

      if (!company && !summary) {
        statusEl.textContent = "최소한 기업 이름이나 한 줄 요약 중 하나는 적어 주세요.";
        return;
      }

      const payload = {
        user_id: user.id,
        book_title: currentBookTitle,
        company,
        section,
        summary,
        what_went_well: good,
        what_went_bad: bad,
        lesson,
        my_action: action
      };

      const { error } = await supabase
        .from("case_notes")
        .insert(payload);

      if (error) {
        console.error("케이스 저장 오류:", error);
        statusEl.textContent = "케이스 저장 중 오류가 발생했습니다.";
      } else {
        statusEl.textContent = "케이스 분석이 저장되었습니다.";
        loadCaseList(user);
      }
    }

    async function loadCaseList(user) {
      const listEl = document.getElementById("caseList");
      if (!listEl) return;

      const { data, error } = await supabase
        .from("case_notes")
        .select("*")
        .eq("user_id", user.id)
        .eq("book_title", currentBookTitle)
        .order("created_at", { ascending: false })
        .limit(10);

      if (error) {
        console.error("케이스 목록 불러오기 오류:", error);
        listEl.innerHTML = `<div class="muted">케이스 목록을 불러오지 못했습니다.</div>`;
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = `<div class="muted">아직 저장된 케이스 분석이 없습니다.</div>`;
        return;
      }

      listEl.innerHTML = "";
      data.forEach(row => {
        const div = document.createElement("div");
        div.className = "log-item";
        const dateLabel = row.created_at ? formatDate(row.created_at) : "";
        div.innerHTML = `
          <div class="log-head">
            <span>${dateLabel} · ${row.company || "기업 미기입"}</span>
            <span class="pill">${row.section || "범위 미기입"}</span>
          </div>
          <div class="log-mainline">${row.summary || ""}</div>
          ${row.lesson ? `<div class="log-quote"><span class="muted">전략 인사이트</span><br>${row.lesson}</div>` : ""}
        `;
        listEl.appendChild(div);
      });
    }

    async function loadDashboard() {
      const container = document.getElementById("dashboardContent");
      if (!container) return;

      container.innerHTML = `<div class="muted">데이터를 불러오는 중...</div>`;

      const { data: profiles, error: profileError } = await supabase
        .from("profiles")
        .select("id, display_name");
      const nameMap = {};
      if (!profileError && profiles) {
        profiles.forEach(p => {
          nameMap[p.id] = p.display_name || "";
        });
      }

      const { data, error } = await supabase
        .from("reading_logs")
        .select("user_id, date")
        .eq("book_title", currentBookTitle)
        .order("date", { ascending: false })
        .limit(500);

      if (error) {
        console.error("대시보드 데이터 오류:", error);
        container.innerHTML = `<div class="muted">대시보드 데이터를 불러오지 못했습니다.</div>`;
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = `<div class="muted">아직 기록된 데이터가 없어 요약을 보여줄 수 없습니다.</div>`;
        return;
      }

      const todayStr = todayISO();
      const todayDate = new Date(todayStr);

      let filtered = data;

      if (currentSeason && currentSeason.start && currentSeason.end) {
        try {
          const start = new Date(currentSeason.start);
          const end = new Date(currentSeason.end);
          filtered = data.filter(row => {
            const d = new Date(row.date);
            return d >= start && d <= end;
          });
        } catch (e) {
          console.error("시즌 날짜 파싱 오류:", e);
        }
      }

      if (filtered.length === 0) {
        container.innerHTML = `<div class="muted">설정된 시즌 안에 해당하는 데이터가 없습니다.</div>`;
        return;
      }

      const todayUsers = new Set();
      const last7Users = new Set();
      const allUsers = new Set();
      const countsByUser = {};

      const sevenAgo = new Date(todayDate.getTime() - 6 * 24 * 60 * 60 * 1000);

      filtered.forEach(row => {
        const uid = row.user_id;
        if (!uid) return;
        allUsers.add(uid);
        countsByUser[uid] = (countsByUser[uid] || 0) + 1;

        if (row.date === todayStr) {
          todayUsers.add(uid);
        }
        try {
          const d = new Date(row.date);
          // 시즌이 있다면 시즌 범위 안 + 최근 7일 교집합
          if (d >= sevenAgo && d <= todayDate) {
            last7Users.add(uid);
          }
        } catch (e) {}
      });

      const totalLogs = filtered.length;
      const todayCount = todayUsers.size;
      const last7Count = last7Users.size;
      const totalMembers = allUsers.size;

      const topMembers = Object.entries(countsByUser)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([uid, count]) => ({
          id: uid,
          name: nameMap[uid] || "익명 멤버",
          count
        }));

      const totalLabel = currentSeason ? "총 기록 수 (이번 시즌)" : "총 기록 수 (최근 데이터 기준)";
      const membersLabel = currentSeason ? "이번 시즌 참여 멤버 수" : "참여한 총 멤버 수";

      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">오늘 기록한 멤버 수</div>
            <div class="stat-value">${todayCount}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">최근 7일 동안 기록한 멤버 수</div>
            <div class="stat-value">${last7Count}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">${totalLabel}</div>
            <div class="stat-value">${totalLogs}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">${membersLabel}</div>
            <div class="stat-value">${totalMembers}</div>
          </div>
        </div>
        <div style="margin-top:0.8rem;">
          <div class="stat-label">가장 활발한 멤버 (현재 데이터 기준)</div>
          ${
            topMembers.length === 0
              ? `<div class="muted">아직 통계를 낼 만큼 데이터가 충분하지 않습니다.</div>`
              : `<ul class="mini-list">` +
                topMembers.map(m => `<li>${m.name} – ${m.count}회 기록</li>`).join("") +
                `</ul>`
          }
        </div>
      `;
    }

    // 클럽 설정 폼 채우기 / 저장
    function fillSettingsForm() {
      const bookInput = document.getElementById("settingBookTitleInput");
      const seasonNameInput = document.getElementById("settingSeasonNameInput");
      const seasonStartInput = document.getElementById("settingSeasonStartInput");
      const seasonEndInput = document.getElementById("settingSeasonEndInput");

      if (bookInput) bookInput.value = currentBookTitle || "";
      if (seasonNameInput) seasonNameInput.value = (currentSeason && currentSeason.name) || "";
      if (seasonStartInput) seasonStartInput.value = (currentSeason && currentSeason.start) || "";
      if (seasonEndInput) seasonEndInput.value = (currentSeason && currentSeason.end) || "";
    }

    async function saveClubSettings(user) {
      const bookInput = document.getElementById("settingBookTitleInput");
      const seasonNameInput = document.getElementById("settingSeasonNameInput");
      const seasonStartInput = document.getElementById("settingSeasonStartInput");
      const seasonEndInput = document.getElementById("settingSeasonEndInput");
      const statusEl = document.getElementById("settingsStatus");

      const newBookTitle = (bookInput.value || "").trim() || DEFAULT_BOOK_TITLE;
      const seasonName = (seasonNameInput.value || "").trim();
      const seasonStart = (seasonStartInput.value || "").trim();
      const seasonEnd = (seasonEndInput.value || "").trim();

      // current_book 설정
      const updates = [
        {
          key: "current_book",
          value: { title: newBookTitle }
        }
      ];

      // 시즌 정보가 어느 정도라도 있으면 저장
      if (seasonName || (seasonStart && seasonEnd)) {
        updates.push({
          key: "season",
          value: {
            name: seasonName || "",
            start: seasonStart || "",
            end: seasonEnd || ""
          }
        });
      }

      const { error } = await supabase
        .from("club_settings")
        .upsert(updates, { onConflict: "key" });

      if (error) {
        console.error("클럽 설정 저장 오류:", error);
        statusEl.textContent = "클럽 설정 저장 중 오류가 발생했습니다.";
      } else {
        statusEl.textContent = "클럽 설정이 저장되었습니다.";
        currentBookTitle = newBookTitle;
        currentSeason = updates.find(u => u.key === "season")?.value || null;

        // 라벨/뷰 갱신
        const headerLabel = document.getElementById("headerBookLabel");
        if (headerLabel) headerLabel.textContent = `${currentBookTitle} · Daily Reading`;
        const bookLabel = document.getElementById("currentBookLabel");
        if (bookLabel) bookLabel.textContent = currentBookTitle;
        const caseBookLabel = document.getElementById("caseBookLabel");
        if (caseBookLabel) caseBookLabel.textContent = currentBookTitle;
        const dashBookLabel = document.getElementById("dashboardBookLabel");
        if (dashBookLabel) dashBookLabel.textContent = currentBookTitle;

        const seasonLabel = document.getElementById("seasonLabel");
        if (seasonLabel) {
          if (currentSeason && currentSeason.name) {
            seasonLabel.textContent = ` · 시즌: ${currentSeason.name} (${currentSeason.start || ""} ~ ${currentSeason.end || ""})`;
          } else {
            seasonLabel.textContent = "";
          }
        }

        // 데이터 다시 로딩
        const session = await getSession();
        if (session && session.user) {
          loadTodayLog(session.user);
          loadRecentLogs(session.user);
          loadClubRecentLogs();
          loadCaseList(session.user);
        }
        loadDashboard();
      }
    }

    // 초기 실행
    (async () => {
      await loadClubSettings();
      const session = await getSession();
      if (session && session.user) {
        renderApp(session.user);
      } else {
        renderLogin("login");
      }
    })();
  </script>
</body>
</html>

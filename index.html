<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>내곁에북클럽 – Daily Reading Log</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root{
      color-scheme: light dark;
      /* Warm Light Palette */
      --bg-primary: #faf6f1;
      --bg-secondary: #f5ede4;
      --bg-card: #fffcf7;
      --bg-input: #faf6f1;
      --text-primary: #3d3229;
      --text-secondary: #6b5c4c;
      --text-muted: #8c7b6b;
      --border-color: #e6ddd3;
      --border-light: #efe7dd;
      --accent: #a85d3b;
      --accent-hover: #8f4e30;
      --accent-light: #f8efe8;
      --accent-text: #7c4a2d;
      --pill-bg: #f0e6db;
      --pill-text: #7c5d45;
      --shadow-soft: rgba(61, 50, 41, 0.06);
      --shadow-medium: rgba(61, 50, 41, 0.12);
    }

    body{
      margin:0;
      font-family: "Apple SD Gothic Neo", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Serif font for headings */
    h1, h2, .logo, .modal-title {
      font-family: "Noto Serif KR", Georgia, "Times New Roman", serif;
    }

    .app-shell{ max-width: 720px; margin: 0 auto; padding: 1.5rem 1.25rem 3rem; box-sizing:border-box; }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
      margin-bottom: 1.2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-light);
    }

    .logo{
      font-weight: 700;
      font-size: 1.3rem;
      line-height: 1.3;
      color: var(--text-primary);
    }
    .logo span{
      display: block;
      font-family: "Apple SD Gothic Neo", system-ui, sans-serif;
      font-weight: 400;
      font-size: .78rem;
      color: var(--text-muted);
      margin-top: .25rem;
      letter-spacing: 0.02em;
    }

    .chip-row{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; justify-content:flex-end; }

    .user-chip{
      font-size: .82rem;
      padding: .35rem .85rem;
      border-radius: 20px;
      background: var(--text-primary);
      color: var(--bg-card);
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      font-weight: 500;
    }
    .user-chip button{
      background: transparent;
      border: none;
      color: inherit;
      font-size: .8rem;
      cursor: pointer;
      padding: 0;
      opacity: 0.85;
    }
    .user-chip button:hover{ opacity: 1; }

    .badge{
      display: none;
      font-size: .72rem;
      padding: .2rem .6rem;
      border-radius: 12px;
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
      font-weight: 600;
    }

    .tabs{
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin: 1rem 0 1.2rem;
      padding-bottom: .8rem;
      border-bottom: 1px solid var(--border-light);
    }
    .tab{
      border-radius: 20px;
      border: 1px solid var(--border-color);
      padding: .45rem 1rem;
      font-size: .85rem;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .tab:hover{
      border-color: var(--accent);
      color: var(--accent);
    }
    .tab.active{
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .card{
      background: var(--bg-card);
      border-radius: 20px;
      padding: 1.25rem 1.35rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px var(--shadow-soft), 0 1px 2px var(--shadow-soft);
      border: 1px solid var(--border-light);
    }

    h2{
      font-size: 1.1rem;
      margin: 0 0 .5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .subtitle{
      font-size: .84rem;
      color: var(--text-muted);
      margin-bottom: .85rem;
      line-height: 1.5;
    }

    label{
      font-size: .82rem;
      display: block;
      margin: .7rem 0 .2rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    input[type="text"], input[type="date"], textarea, select{
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: .6rem .8rem;
      font-size: .92rem;
      font-family: inherit;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus{
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    textarea{ min-height: 90px; resize: vertical; line-height: 1.5; }

    .row{ display: flex; flex-wrap: wrap; gap: .75rem; }
    .row>div{ flex: 1 1 180px; }

    .btn-row{ display: flex; gap: .6rem; flex-wrap: wrap; margin-top: 1rem; }

    button.primary{
      width: 100%;
      border-radius: 24px;
      border: none;
      padding: .7rem 1.2rem;
      font-size: .95rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }
    button.primary:hover{ background: var(--accent-hover); }
    button.primary:active{ transform: scale(0.98); }

    button.secondary{
      width: 100%;
      border-radius: 24px;
      border: 1px solid var(--border-color);
      padding: .7rem 1.2rem;
      font-size: .95rem;
      font-weight: 600;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    button.secondary:hover{ border-color: var(--text-muted); }

    .muted{ font-size: .82rem; color: var(--text-muted); }

    .logs-list{ display: flex; flex-direction: column; gap: .7rem; margin-top: .4rem; }

    .log-item{
      padding: .85rem 1rem;
      border-radius: 16px;
      border: 1px solid var(--border-light);
      background: var(--bg-secondary);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .log-item:hover{
      border-color: var(--border-color);
      box-shadow: 0 2px 6px var(--shadow-soft);
    }

    .log-head{
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      font-size: .78rem;
      margin-bottom: .4rem;
      color: var(--text-muted);
      align-items: center;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      padding: .15rem .6rem;
      border-radius: 12px;
      background: var(--pill-bg);
      color: var(--pill-text);
      font-size: .74rem;
      font-weight: 500;
    }
    .pill.archive{
      background: #fef3e2;
      color: #b45309;
    }

    .log-mainline{
      font-size: .9rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .log-sub{ margin-top: .3rem; font-size: .85rem; white-space: pre-wrap; color: var(--text-secondary); }

    .item-actions{ margin-top: .65rem; display: flex; gap: .45rem; flex-wrap: wrap; justify-content: flex-end; }

    .mini-btn{
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      border-radius: 16px;
      padding: .32rem .7rem;
      font-size: .78rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .mini-btn:hover{
      border-color: var(--accent);
      color: var(--accent);
    }
    .mini-btn.primary{
      border-color: var(--accent);
      color: var(--accent);
    }

    .filters{ display: flex; flex-wrap: wrap; gap: .6rem; align-items: flex-end; margin: .7rem 0 .3rem; }
    .filters .field{ flex: 1 1 180px; }
    .filters label{ margin-top: 0; }

    .field-row{ display: flex; gap: 20px; align-items: flex-end; }
    .field-row .field{ flex: 1; }

    .split{ display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 900px){ .split{ grid-template-columns: 1fr 1fr; } }

    .section-hidden{ display: none; }

    /* Archive selector */
    .archive-selector{
      margin-bottom: 1rem;
      padding: .9rem 1rem;
      background: #fef9f0;
      border: 1px solid #f0dcc8;
      border-radius: 16px;
    }
    .archive-selector label{ margin: 0 0 .35rem; color: var(--accent-text); }
    .archive-selector select{ background: #fffdf8; border-color: #e8d4c0; }

    /* Modal */
    #modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(61, 50, 41, 0.5);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 1rem;
      padding-top: 8vh;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }
    #modalBackdrop.open{ display: flex; }

    .modal{
      width: min(680px, 100%);
      max-height: calc(100vh - 8vh - 2rem - env(safe-area-inset-bottom));
      overflow: auto;
      background: var(--bg-card);
      border-radius: 24px;
      border: 1px solid var(--border-light);
      box-shadow: 0 20px 50px rgba(61, 50, 41, 0.25);
    }

    .modal-header{
      position: sticky;
      top: 0;
      background: inherit;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: .8rem;
      padding: 1.1rem 1.25rem .8rem;
      border-bottom: 1px solid var(--border-light);
    }

    .modal-title{ font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }

    .modal-close{
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1.5rem;
      line-height: 1;
      padding: .1rem .3rem;
      color: var(--text-muted);
      transition: color 0.2s ease;
    }
    .modal-close:hover{ color: var(--text-primary); }

    .modal-body{ padding: 1rem 1.25rem 1.25rem; }

    .kv{
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: .8rem;
      padding: .65rem 0;
      border-bottom: 1px dashed var(--border-light);
    }
    .kv:last-child{ border-bottom: none; }
    .kv .k{ font-size: .82rem; color: var(--text-muted); font-weight: 500; }
    .kv .v{ font-size: .92rem; white-space: normal; color: var(--text-primary); line-height: 1.5; }

    .modal-footer{ padding: 1rem 1.25rem 1.25rem; border-top: 1px solid var(--border-light); }

    /* button, input adjustments */
    #myLogApply,#clubLogApply{ width: 100%; padding: .5rem .85rem; font-size: .85rem; }

    /* Dark Mode - Warm Sepia Tones */
    @media (prefers-color-scheme: dark) {
      :root{
        --bg-primary: #1a1614;
        --bg-secondary: #231f1c;
        --bg-card: #2a2522;
        --bg-input: #1a1614;
        --text-primary: #f0e6dc;
        --text-secondary: #c4b5a5;
        --text-muted: #8c7b6b;
        --border-color: #3d3530;
        --border-light: #332e2a;
        --accent: #d4896a;
        --accent-hover: #e09a7d;
        --accent-light: rgba(212, 137, 106, 0.15);
        --accent-text: #e8a988;
        --pill-bg: #3d3530;
        --pill-text: #c4b5a5;
        --shadow-soft: rgba(0, 0, 0, 0.2);
        --shadow-medium: rgba(0, 0, 0, 0.3);
      }

      .user-chip{
        background: var(--text-primary);
        color: var(--bg-primary);
      }

      .badge{
        background: rgba(76, 175, 80, 0.15);
        color: #81c784;
        border-color: rgba(76, 175, 80, 0.3);
      }

      #modalBackdrop{ background: rgba(0, 0, 0, 0.65); }

      .archive-selector{
        background: #2d2520;
        border-color: #4a3f38;
      }
      .archive-selector label{ color: var(--accent-text); }
      .archive-selector select{
        background: var(--bg-card);
        border-color: #4a3f38;
        color: var(--text-primary);
      }

      .pill.archive{
        background: #3d3025;
        color: #e8a055;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
<header>
<div class="logo">
        내곁에북클럽
        <span id="headerBookLabel">Daily Reading</span>
</div>
<div class="chip-row" id="userArea"></div>
</header>
<main id="content"></main>
</div>
<!-- Modal -->
<div aria-hidden="true" id="modalBackdrop">
<div aria-labelledby="modalTitle" aria-modal="true" class="modal" role="dialog">
<div class="modal-header">
<div>
<div class="modal-title" id="modalTitle">상세 보기</div>
<div class="muted" id="modalSubtitle" style="margin-top:.25rem;"></div>
</div>
<button aria-label="닫기" class="modal-close" id="modalCloseBtn">×</button>
</div>
<div class="modal-body" id="modalBody"></div>
<div class="modal-footer section-hidden" id="modalFooter"></div>
</div>
</div>
<script>
(() => {
  // ====== CONFIG ======
  const SUPABASE_URL = "https://mpmjjkosxhnffwymspru.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wbWpqa29zeGhuZmZ3eW1zcHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNDQwMDIsImV4cCI6MjA4MDcyMDAwMn0.MAauyc4e459U6YVh4TTSL3PF1HO-mQGb4ujHEKKfqjY";

  const PROJECT_URL = "https://lyngw.github.io/bookclub/";
  const DEFAULT_BOOK_TITLE = "Lessons from the Titans";

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== STATE ======
  let appBooted = false;
  let currentBookTitle = DEFAULT_BOOK_TITLE;
  let currentSeason = null;   // { id, name, start, end }
  let sessionUser = null;
  let isAdmin = false;
  let profileName = "";
  let todayFormDirty = false;
  let todayLoadSeq = 0;

  // Archive state
  let archivedBooks = []; // [{book_title, season_id, season_name, count}]
  let selectedArchive = null; // {book_title, season_id}

  // ====== HELPERS ======
  const $ = (id) => document.getElementById(id);

  function wireEnterSearch(inputId, onEnter) {
    const el = $(inputId);
    if (!el) return;
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        onEnter();
      }
    });
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function safeHtmlWithBreaks(text) {
    const escaped = escapeHtml(text ?? "");
    return escaped.replace(/\n/g, "<br>");
  }

  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function formatDate(iso) {
    if (!iso) return "";
    try {
      const d = new Date(iso);
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return `${m}/${day}`;
    } catch {
      return String(iso);
    }
  }

  function setStatus(id, msg) {
    const el = $(id);
    if (el) el.textContent = msg || "";
  }

  function resetTodayForm() {
    const ids = ["sectionInput","keyPointsInput","quoteInput","reflectionInput"];
    ids.forEach(x => { const el = $(x); if (el) el.value = ""; });
  }

  // ====== MODAL ======
  function openModal({ title, subtitle, fields, footerHtml }) {
    const backdrop = $("modalBackdrop");
    const titleEl = $("modalTitle");
    const subEl = $("modalSubtitle");
    const bodyEl = $("modalBody");
    const footerEl = $("modalFooter");

    titleEl.textContent = typeof title === "string" ? title : (title ? String(title) : "");
    subEl.textContent = subtitle || "";

    if (!Array.isArray(fields) || fields.length === 0) {
      bodyEl.innerHTML = `<div class="muted">표시할 내용이 없습니다.</div>`;
    } else {
      bodyEl.innerHTML = fields.map(f => {
        const label = (f && (f.label ?? f.k ?? "")) || "";
        let raw = (f && (f.value ?? f.v ?? "")) ?? "";
        if (raw === null || raw === undefined) raw = "";
        if (typeof raw !== "string") {
          try { raw = JSON.stringify(raw, null, 2); } catch { raw = String(raw); }
        }
        const valueHtml = safeHtmlWithBreaks(raw);
        return `<div class="kv">
                  <div class="k">${escapeHtml(String(label))}</div>
                  <div class="v">${valueHtml}</div>
                </div>`;
      }).join("");
    }

    if (footerHtml) {
      footerEl.innerHTML = footerHtml;
      footerEl.classList.remove("section-hidden");
    } else {
      footerEl.innerHTML = "";
      footerEl.classList.add("section-hidden");
    }

    backdrop.classList.add("open");
    backdrop.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    const backdrop = $("modalBackdrop");
    if (!backdrop) return;
    backdrop.classList.remove("open");
    backdrop.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  function wireModalEvents() {
    const backdrop = $("modalBackdrop");
    const closeBtn = $("modalCloseBtn");
    if (closeBtn) closeBtn.onclick = closeModal;
    if (backdrop) {
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeModal();
      });
    }
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });
  }

  // ====== AUTH / ADMIN / SETTINGS ======
  async function getSession() {
    const { data } = await supabase.auth.getSession();
    return data.session;
  }

  async function ensureProfile(user) {
    try {
      const { data: existing, error } = await supabase
        .from("profiles")
        .select("id, display_name")
        .eq("id", user.id)
        .maybeSingle();

      if (error && error.code !== "PGRST116") {
        console.warn("profiles select error:", error);
      }

      if (existing && existing.id) {
        profileName = existing.display_name || guessName(user) || "멤버";
        return;
      }

      const guess = guessName(user) || "멤버";
      const { error: insErr } = await supabase
        .from("profiles")
        .insert({ id: user.id, display_name: guess });
      if (insErr) {
        console.warn("profiles insert error:", insErr);
      }
      profileName = guess;
    } catch (e) {
      console.warn("ensureProfile exception:", e);
      profileName = guessName(user) || "멤버";
    }
  }

  function guessName(user) {
    const md = user?.user_metadata || {};
    const candidates = [
      md.full_name, md.name, md.nickname, md.preferred_username,
      md.user_name, md.display_name
    ].filter(Boolean);
    if (candidates.length > 0) return String(candidates[0]);
    return "";
  }

  async function checkAdmin(user) {
    isAdmin = false;
    try {
      const { data, error } = await supabase
        .from("admin_users")
        .select("user_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (error) {
        console.warn("admin_users check error:", error);
        isAdmin = false;
        return;
      }
      isAdmin = !!(data && data.user_id);
    } catch (e) {
      console.warn("checkAdmin exception:", e);
      isAdmin = false;
    }
  }

  async function loadClubSettings() {
    currentBookTitle = DEFAULT_BOOK_TITLE;
    currentSeason = null;
    try {
      const { data, error } = await supabase
        .from("club_settings")
        .select("key, value");

      if (!error && data) {
        data.forEach(row => {
          if (row.key === "current_book" && row.value && row.value.title) {
            currentBookTitle = row.value.title;
          }
          if (row.key === "season" && row.value) {
            currentSeason = row.value;
          }
        });
      }
    } catch (e) {
      console.warn("loadClubSettings exception:", e);
    }

    const header = $("headerBookLabel");
    if (header) {
      const seasonTxt = currentSeason?.name ? ` · ${currentSeason.name}` : "";
      header.textContent = `${currentBookTitle} · Daily Reading${seasonTxt}`;
    }
  }

  function seasonIdOrNull() {
    const id = currentSeason?.id;
    return id ? id : null;
  }

  // ====== UI: LOGIN ======
  function renderLogin() {
    const root = $("content");
    const userArea = $("userArea");
    userArea.innerHTML = "";

    root.innerHTML = `
      <section class="card">
        <h2>로그인</h2>
        <div class="subtitle">카카오로 로그인해 오늘의 독서 기록을 남겨보세요.</div>
        <button class="primary" id="kakaoLoginBtn" style="background:#FEE500; color:#000;">카카오로 로그인</button>
        <div class="muted" style="margin-top:.6rem;">※ 이메일 로그인은 사용하지 않습니다.</div>
      </section>
    `;

    const btn = $("kakaoLoginBtn");
    if (btn) {
      btn.onclick = async () => {
        await supabase.auth.signInWithOAuth({
          provider: "kakao",
          options: { redirectTo: PROJECT_URL }
        });
      };
    }
  }

  // ====== UI: APP SHELL / TABS ======
  function setupTabs() {
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const sections = Array.from(document.querySelectorAll("[data-section]"));

    const activate = (name) => {
      tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
      sections.forEach(s => s.classList.toggle("section-hidden", s.dataset.section !== name));

      // 아카이브 탭 활성화 시 데이터 로드
      if (name === "archive") {
        loadArchivedBooks();
      }
    };

    tabs.forEach(t => t.addEventListener("click", () => activate(t.dataset.tab)));
    activate("today");
  }

  function renderUserArea() {
    const userArea = $("userArea");
    userArea.innerHTML = `
      <span id="adminBadge" class="badge">ADMIN</span>
      <div class="user-chip">
        <span id="headerDisplayName">${escapeHtml(profileName || "멤버")}</span>
        <button id="logoutBtn">로그아웃</button>
      </div>
    `;

    const badge = $("adminBadge");
    if (badge && isAdmin) badge.style.display = "inline-flex";

    const logoutBtn = $("logoutBtn");
    if (logoutBtn) {
      logoutBtn.onclick = async () => {
        await supabase.auth.signOut();
        sessionUser = null;
        renderLogin();
      };
    }
  }

  async function saveNickname(user) {
    const input = $("nicknameInput");
    const statusEl = $("nicknameStatus");
    const headerName = $("headerDisplayName");
    const newName = (input && input.value ? input.value : "").trim();
    if (!user) return;
    if (!newName) {
      if (statusEl) statusEl.textContent = "닉네임을 입력해 주세요.";
      return;
    }
    const { error } = await supabase
      .from("profiles")
      .upsert({ id: user.id, display_name: newName }, { onConflict: "id" });
    if (error) {
      console.error("닉네임 저장 오류:", error);
      if (statusEl) statusEl.textContent = "닉네임 저장 중 오류가 발생했습니다.";
      return;
    }
    profileName = newName;
    if (statusEl) statusEl.textContent = "닉네임이 저장되었습니다.";
    if (headerName) headerName.textContent = newName;
    await loadClubLogs(true);
    await loadDashboard();
  }


  function renderApp() {
    const root = $("content");

    root.innerHTML = `
      <nav class="tabs">
        <button class="tab" data-tab="profile">프로필</button>
        <button class="tab" data-tab="today">오늘 기록</button>
        <button class="tab" data-tab="logs">기록 보기</button>
        <button class="tab" data-tab="archive">아카이브</button>
        <button class="tab" data-tab="dashboard">대시보드</button>
        ${isAdmin ? `<button class="tab" data-tab="admin">관리자</button>` : ``}
      </nav>

      <section class="card section-hidden" data-section="profile" id="profileSection">
        <h2>내 프로필</h2>
        <div class="subtitle">클럽에서 보이는 이름(닉네임)을 바꿀 수 있어요.</div>
          <label>닉네임</label>
          <input id="nicknameInput" type="text" placeholder="예: 내곁에서재" />
          <button class="primary" id="saveNicknameBtn">닉네임 저장</button>
        <div class="muted" id="nicknameStatus"></div>
      </section>

      <section class="card" data-section="today" id="todaySection">
        <h2>오늘의 독서 기록</h2>
        <div class="subtitle">
          오늘 <b>${escapeHtml(currentBookTitle)}</b>에서 읽은 내용을 정리해 보세요. (자동으로 오늘 날짜로 저장됩니다.)
          <span id="seasonHint" class="muted"></span>
        </div>
        <div class="row">
          <div>
            <label>읽은 범위 (챕터 / 페이지)</label>
            <input id="sectionInput" type="text" placeholder="예: Chapter 3 · p.45–70" />
          </div>
          <div>
            <label>날짜</label>
            <input id="dateInput" type="text" disabled />
          </div>
        </div>
        <label>오늘의 핵심 포인트</label>
        <textarea id="keyPointsInput" placeholder="핵심 문장 2~3줄로 요약해 보세요."></textarea>
        <label>오늘의 한 문장</label>
        <textarea id="quoteInput" placeholder="원문 그대로 옮겨 적어도, 요약해 적어도 좋아요."></textarea>
        <label>느낀 점 / 적용 아이디어</label>
        <textarea id="reflectionInput" placeholder="오늘 배운 점과 적용할 부분을 적어보세요."></textarea>

        <div class="btn-row">
          <button class="primary" id="saveTodayBtn">저장</button>
          <button class="secondary" id="clearTodayBtn">입력 초기화</button>
        </div>
        <div class="muted" id="saveStatus"></div>
      </section>

      <section data-section="logs" id="logsSection">
        <section class="card">
          <h2>나의 기록</h2>
          <div class="subtitle">현재 시즌의 최근 기록을 불러오고, 클릭하면 전체 내용을 확인할 수 있어요.</div>
          <div class="filters">
            <div class="field">
              <label>검색</label>
              <input id="myLogSearch" type="text" placeholder="키워드 (범위/요약/문장/느낀점)" />
            </div>
          </div>
          <div id="myLogsList" class="logs-list"></div>
        </section>

        <section class="card">
          <h2>클럽 기록</h2>
          <div class="subtitle">현재 시즌의 멤버들 최근 기록을 함께 봐요. (클릭하면 전체 보기)</div>
          <div class="filters">
            <div class="field">
              <label>검색</label>
              <input id="clubLogSearch" type="text" placeholder="키워드 (범위/요약/문장/느낀점)" />
            </div>
          </div>
          <div id="clubLogsList" class="logs-list"></div>
        </section>
      </section>

      <section class="card" data-section="archive" id="archiveSection">
        <h2>아카이브</h2>
        <div class="subtitle">이전 시즌/책의 기록을 확인할 수 있어요.</div>

        <div class="archive-selector">
          <label>이전 시즌/책 선택</label>
          <select id="archiveSelect">
            <option value="">-- 선택하세요 --</option>
          </select>
        </div>

        <div id="archiveContent">
          <div class="muted">위에서 이전 시즌/책을 선택하면 기록이 표시됩니다.</div>
        </div>

        <div class="filters" id="archiveFilters" style="display:none;">
          <div class="field">
            <label>검색</label>
            <input id="archiveSearch" type="text" placeholder="키워드 (범위/요약/문장/느낀점)" />
          </div>
        </div>
        <div id="archiveLogsList" class="logs-list" style="margin-top:.6rem;"></div>
      </section>

      <section class="card" data-section="dashboard" id="dashboardSection">
        <h2>클럽 대시보드</h2>
        <div class="subtitle">
          <span>현재 책: <b>${escapeHtml(currentBookTitle)}</b></span>
          <span id="seasonLabel" class="muted"></span>
        </div>
        <div id="dashboardContent" class="muted">데이터를 불러오는 중...</div>
      </section>

      ${isAdmin ? `
      <section class="card" data-section="admin" id="adminSection">
        <h2>관리자 설정</h2>
        <div class="subtitle">현재 책/시즌을 설정하고, 관리자를 지정할 수 있어요. 새 시즌을 설정하면 이전 기록은 아카이브에서 확인할 수 있습니다.</div>

        <div class="split">
          <div>
            <h2 style="margin-top:0.2rem;">클럽 설정</h2>
            <label>현재 책 제목</label>
            <input id="settingBookTitleInput" type="text" />
            <label>시즌 ID (UUID, 선택)</label>
            <input id="settingSeasonIdInput" type="text" placeholder="예: 4b6c... (없으면 비워도 됨)" />
            <label>시즌 이름 (선택)</label>
            <input id="settingSeasonNameInput" type="text" placeholder="예: 1기 · Titans 12월" />
            <div class="row">
              <div>
                <label>시즌 시작일</label>
                <input id="settingSeasonStartInput" type="date" />
              </div>
              <div>
                <label>시즌 종료일</label>
                <input id="settingSeasonEndInput" type="date" />
              </div>
            </div>
            <button class="primary" id="saveSettingsBtn">클럽 설정 저장</button>
            <div class="muted" id="settingsStatus"></div>
          </div>

          <div>
            <h2 style="margin-top:0.2rem;">관리자 지정</h2>
            <div class="subtitle">카카오로 로그인한 사용자의 <b>user_id(UUID)</b>를 admin_users에 넣으면 됩니다.</div>
            <label>추가할 user_id</label>
            <input id="adminUserIdInput" type="text" placeholder="예: ea9f1ef2-..." />
            <button class="primary" id="addAdminBtn">관리자 추가</button>
            <div class="muted" id="adminStatus"></div>

            <div style="margin-top:.9rem;">
              <h2 style="margin-top:0.2rem;">현재 관리자 목록</h2>
              <div id="adminList" class="logs-list"></div>
            </div>
          </div>
        </div>
      </section>
      ` : ``}
    `;

    // 초기값 채우기
    const nickInput = document.getElementById("nicknameInput");
    if (nickInput) nickInput.value = profileName || "";
    const saveNickBtn = document.getElementById("saveNicknameBtn");
    if (saveNickBtn) saveNickBtn.onclick = () => saveNickname(sessionUser);

    // season hints
    const seasonHint = $("seasonHint");
    const seasonLabel = $("seasonLabel");
    if (currentSeason?.name) {
      const start = currentSeason.start || "";
      const end = currentSeason.end || "";
      const txt = ` · 시즌: ${currentSeason.name} (${start} ~ ${end})`;
      if (seasonHint) seasonHint.textContent = txt;
      if (seasonLabel) seasonLabel.textContent = txt;
    } else {
      if (seasonHint) seasonHint.textContent = "";
      if (seasonLabel) seasonLabel.textContent = "";
    }

    // today form dirty tracking
    todayFormDirty = false;
    ["sectionInput","keyPointsInput","quoteInput","reflectionInput"].forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener("input", () => {
        todayFormDirty = true;
      }, { passive: true });
    });

    // wire actions
    $("dateInput").value = todayISO();
    $("saveTodayBtn").onclick = saveTodayLog;
    $("clearTodayBtn").onclick = () => { resetTodayForm(); setStatus("saveStatus","입력을 초기화했습니다."); };

    wireEnterSearch("myLogSearch", () => loadMyLogs());
    wireEnterSearch("clubLogSearch", () => loadClubLogs());
    wireEnterSearch("archiveSearch", () => loadArchiveLogs());

    // Archive select handler
    const archiveSelect = $("archiveSelect");
    if (archiveSelect) {
      archiveSelect.onchange = () => {
        const val = archiveSelect.value;
        if (!val) {
          selectedArchive = null;
          $("archiveFilters").style.display = "none";
          $("archiveLogsList").innerHTML = "";
          $("archiveContent").innerHTML = `<div class="muted">위에서 이전 시즌/책을 선택하면 기록이 표시됩니다.</div>`;
          return;
        }
        const [bookTitle, seasonId] = val.split("|||");
        selectedArchive = { book_title: bookTitle, season_id: seasonId || null };
        $("archiveFilters").style.display = "flex";
        $("archiveContent").innerHTML = "";
        loadArchiveLogs();
      };
    }

    if (isAdmin) {
      fillAdminForms();
      $("saveSettingsBtn").onclick = saveClubSettings;
      $("addAdminBtn").onclick = addAdminUser;
      loadAdminList();
    }

    setupTabs();

    // initial loads
    loadTodayLog();
    loadMyLogs();
    loadClubLogs();
    loadDashboard();
  }

  // ====== DATA: PROFILES MAP ======
  async function loadProfilesMap() {
    const map = {};
    try {
      const { data, error } = await supabase.from("profiles").select("id, display_name");
      if (!error && data) {
        data.forEach(p => map[p.id] = p.display_name || "");
      }
    } catch (e) {}
    return map;
  }

  // ====== DATA: TODAY LOG ======
  async function loadTodayLog() {
    const seq = ++todayLoadSeq;
    setStatus("saveStatus", "불러오는 중...");
    try {
      const today = todayISO();
      const { data, error } = await supabase
        .from("reading_logs")
        .select("*")
        .eq("user_id", sessionUser.id)
        .eq("date", today)
        .eq("book_title", currentBookTitle)
        .eq("archived", false)
        .maybeSingle();

      if (error && error.code !== "PGRST116") {
        console.error("loadTodayLog error:", error);
        setStatus("saveStatus", "오늘 기록을 불러오지 못했습니다.");
        return;
      }

      if (seq !== todayLoadSeq) return;

      if (todayFormDirty) {
        setStatus("saveStatus", "입력 중입니다. 자동 로딩으로 덮어쓰지 않습니다.");
        return;
      }

      if (data) {
        $("sectionInput").value = data.section || "";
        $("keyPointsInput").value = data.key_points || "";
        $("quoteInput").value = data.quote || "";
        $("reflectionInput").value = data.reflection || "";
        setStatus("saveStatus", "이미 저장된 오늘의 기록을 불러왔습니다. (저장하면 업데이트됩니다)");
      } else {
        resetTodayForm();
        setStatus("saveStatus", "아직 오늘의 기록이 없습니다. 새로 작성해 보세요.");
      }
    } catch (e) {
      console.error("loadTodayLog exception:", e);
      setStatus("saveStatus", "오늘 기록을 불러오지 못했습니다.");
    }
  }

  async function saveTodayLog() {
    const date = todayISO();
    const payload = {
      user_id: sessionUser.id,
      date,
      book_title: currentBookTitle,
      season_id: seasonIdOrNull(),
      section: ($("sectionInput").value || "").trim(),
      key_points: ($("keyPointsInput").value || "").trim(),
      quote: ($("quoteInput").value || "").trim(),
      reflection: ($("reflectionInput").value || "").trim(),
      archived: false
    };

    setStatus("saveStatus","저장 중...");
    const { error } = await supabase
      .from("reading_logs")
      .upsert(payload, { onConflict: "user_id,date,book_title" });

    if (error) {
      console.error("saveTodayLog error:", error);
      setStatus("saveStatus","저장 중 오류가 발생했습니다.");
      return;
    }

    setStatus("saveStatus","저장되었습니다. (입력창을 초기화했습니다)");
    resetTodayForm();
    await loadMyLogs();
    await loadClubLogs();
    await loadDashboard();
  }

  // ====== DATA: LOG LISTS (SERVER FILTER) ======
  function applyLogQuery(base, { search, start, end, onlyMine, bookTitle, seasonId, useCurrentSeason = true }) {
    const targetBook = bookTitle || currentBookTitle;
    let q = base
      .eq("book_title", targetBook)
      .eq("archived", false)
      .order("date", { ascending: false })
      .limit(50);

    if (onlyMine) q = q.eq("user_id", sessionUser.id);

    // 시즌 필터링
    if (useCurrentSeason && seasonIdOrNull()) {
      q = q.eq("season_id", seasonIdOrNull());
    } else if (seasonId !== undefined) {
      if (seasonId === null || seasonId === "") {
        q = q.is("season_id", null);
      } else {
        q = q.eq("season_id", seasonId);
      }
    }

    if (start) q = q.gte("date", start);
    if (end) q = q.lte("date", end);

    if (search) {
      const s = search.replaceAll('"','\"');
      q = q.or(`section.ilike.%${s}%,key_points.ilike.%${s}%,quote.ilike.%${s}%,reflection.ilike.%${s}%`);
    }
    return q;
  }

  async function loadMyLogs() {
    const listEl = $("myLogsList");
    if (!listEl) return;
    listEl.innerHTML = `<div class="muted">불러오는 중...</div>`;

    const search = ($("myLogSearch")?.value || "").trim();

    const { data, error } = await applyLogQuery(
      supabase.from("reading_logs").select("*"),
      { search, onlyMine: true }
    );

    if (error) {
      console.error("loadMyLogs error:", error);
      listEl.innerHTML = `<div class="muted">최근 기록을 불러오지 못했습니다.</div>`;
      return;
    }

    if (!data || data.length === 0) {
      listEl.innerHTML = `<div class="muted">표시할 기록이 없습니다.</div>`;
      return;
    }

    listEl.innerHTML = "";
    data.forEach(row => listEl.appendChild(renderLogCard(row, { scope: "mine" })));
  }

  async function loadClubLogs() {
    const listEl = $("clubLogsList");
    if (!listEl) return;
    listEl.innerHTML = `<div class="muted">불러오는 중...</div>`;

    const search = ($("clubLogSearch")?.value || "").trim();

    const nameMap = await loadProfilesMap();

    const { data, error } = await applyLogQuery(
      supabase.from("reading_logs").select("*"),
      { search, onlyMine: false }
    );

    if (error) {
      console.error("loadClubLogs error:", error);
      listEl.innerHTML = `<div class="muted">클럽 기록을 불러오지 못했습니다.</div>`;
      return;
    }

    if (!data || data.length === 0) {
      listEl.innerHTML = `<div class="muted">표시할 기록이 없습니다.</div>`;
      return;
    }

    listEl.innerHTML = "";
    data.forEach(row => listEl.appendChild(renderLogCard(row, { scope: "club", nameMap })));
  }

  function renderLogCard(row, opts={}) {
    const div = document.createElement("div");
    div.className = "log-item";

    const nameMap = opts.nameMap || {};
    const who = (row.user_id === sessionUser.id) ? "나" : (nameMap[row.user_id] || "멤버");
    const headLeft = `${formatDate(row.date)} · ${who}`;
    const section = row.section || "범위 미기입";
    const keypoints = row.key_points || "";
    const isArchive = opts.isArchive || false;

    const preview = keypoints || row.quote || "";
    const previewHtml = safeHtmlWithBreaks(preview);

    div.innerHTML = `
      <div class="log-head">
        <span>${escapeHtml(headLeft)}</span>
        <span class="pill${isArchive ? ' archive' : ''}">${escapeHtml(section)}</span>
      </div>
      <div class="log-mainline">${previewHtml || `<span class="muted">(내용 없음)</span>`}</div>
      <div class="item-actions">
        <button class="mini-btn" data-act="details">자세히</button>
        ${(row.user_id === sessionUser.id && !isArchive) ? `<button class="mini-btn primary" data-act="edit">수정</button>` : ``}
      </div>
    `;

    div.querySelector('[data-act="details"]').onclick = () => openLogDetails(row);
    const editBtn = div.querySelector('[data-act="edit"]');
    if (editBtn) editBtn.onclick = () => openLogEdit(row);

    return div;
  }

  async function openLogDetails(arg) {
    let row = arg;
    if (typeof arg === "string") {
      const { data, error } = await supabase
        .from("reading_logs")
        .select("*")
        .eq("id", arg)
        .maybeSingle();
      if (error) {
        console.error("openLogDetails fetch error:", error);
        alert("상세 데이터를 불러오지 못했습니다.");
        return;
      }
      row = data;
    }
    if (!row) return;

    openModal({
      title: "독서 기록 상세",
      subtitle: `${formatDate(row.date)} · ${escapeHtml(row.book_title || currentBookTitle)}`,
      fields: [
        { label:"읽은 범위", value: row.section || "" },
        { label:"핵심 포인트", value: row.key_points || "" },
        { label:"오늘의 한 문장", value: row.quote || "" },
        { label:"느낀 점/적용", value: row.reflection || "" }
      ],
      footerHtml: ""
    });
  }

  function openLogEdit(row) {
    if (!row || row.user_id !== sessionUser.id) return;

    const footerHtml = `
      <div class="subtitle" style="margin:0 0 .5rem;">수정 후 저장하면 업데이트됩니다.</div>
      <label>읽은 범위</label>
      <input id="editLogSection" type="text" value="${escapeHtml(row.section || "")}" />
      <label>핵심 포인트</label>
      <textarea id="editLogKey">${escapeHtml(row.key_points || "")}</textarea>
      <label>오늘의 한 문장</label>
      <textarea id="editLogQuote">${escapeHtml(row.quote || "")}</textarea>
      <label>느낀 점/적용</label>
      <textarea id="editLogRef">${escapeHtml(row.reflection || "")}</textarea>
      <div class="btn-row">
        <button class="primary" id="editLogSaveBtn">저장</button>
        <button class="secondary" id="editLogCancelBtn">닫기</button>
      </div>
      <div class="muted" id="editLogStatus"></div>
    `;

    openModal({
      title: "독서 기록 수정",
      subtitle: `${formatDate(row.date)} · ${escapeHtml(currentBookTitle)}`,
      fields: [
        { label:"기록 ID", value: row.id },
      ],
      footerHtml
    });

    $("editLogCancelBtn").onclick = closeModal;
    $("editLogSaveBtn").onclick = async () => {
      $("editLogStatus").textContent = "저장 중...";
      const payload = {
        id: row.id,
        user_id: sessionUser.id,
        date: row.date,
        book_title: currentBookTitle,
        season_id: row.season_id ?? seasonIdOrNull(),
        section: ($("editLogSection").value || "").trim(),
        key_points: ($("editLogKey").value || "").trim(),
        quote: ($("editLogQuote").value || "").trim(),
        reflection: ($("editLogRef").value || "").trim(),
        archived: false
      };
      const { error } = await supabase.from("reading_logs").update(payload).eq("id", row.id);
      if (error) {
        console.error("editLog save error:", error);
        $("editLogStatus").textContent = "저장 실패";
        return;
      }
      $("editLogStatus").textContent = "저장 완료";
      closeModal();
      await loadMyLogs();
      await loadClubLogs();
      await loadDashboard();
    };
  }

  // ====== ARCHIVE ======
  async function loadArchivedBooks() {
    const selectEl = $("archiveSelect");
    if (!selectEl) return;

    selectEl.innerHTML = `<option value="">불러오는 중...</option>`;

    try {
      // 모든 reading_logs에서 고유한 book_title, season_id 조합 가져오기
      const { data, error } = await supabase
        .from("reading_logs")
        .select("book_title, season_id")
        .eq("archived", false);

      if (error) {
        console.error("loadArchivedBooks error:", error);
        selectEl.innerHTML = `<option value="">불러오기 실패</option>`;
        return;
      }

      // 고유 조합 추출 (현재 시즌/책 제외)
      const uniqueMap = new Map();
      data.forEach(row => {
        const key = `${row.book_title}|||${row.season_id || ""}`;
        // 현재 시즌/책은 제외
        const isCurrent = row.book_title === currentBookTitle &&
          (row.season_id === seasonIdOrNull() || (!row.season_id && !seasonIdOrNull()));
        if (!isCurrent) {
          if (!uniqueMap.has(key)) {
            uniqueMap.set(key, { book_title: row.book_title, season_id: row.season_id, count: 0 });
          }
          uniqueMap.get(key).count++;
        }
      });

      archivedBooks = Array.from(uniqueMap.values());

      // 드롭다운 옵션 생성
      if (archivedBooks.length === 0) {
        selectEl.innerHTML = `<option value="">아카이브된 기록이 없습니다</option>`;
        return;
      }

      selectEl.innerHTML = `<option value="">-- 선택하세요 --</option>`;
      archivedBooks.forEach(item => {
        const opt = document.createElement("option");
        opt.value = `${item.book_title}|||${item.season_id || ""}`;
        const seasonLabel = item.season_id ? ` (시즌: ${item.season_id.substring(0,8)}...)` : " (시즌 없음)";
        opt.textContent = `${item.book_title}${seasonLabel} - ${item.count}개 기록`;
        selectEl.appendChild(opt);
      });

    } catch (e) {
      console.error("loadArchivedBooks exception:", e);
      selectEl.innerHTML = `<option value="">불러오기 실패</option>`;
    }
  }

  async function loadArchiveLogs() {
    const listEl = $("archiveLogsList");
    if (!listEl || !selectedArchive) return;

    listEl.innerHTML = `<div class="muted">불러오는 중...</div>`;

    const search = ($("archiveSearch")?.value || "").trim();
    const nameMap = await loadProfilesMap();

    const { data, error } = await applyLogQuery(
      supabase.from("reading_logs").select("*"),
      {
        search,
        onlyMine: false,
        bookTitle: selectedArchive.book_title,
        seasonId: selectedArchive.season_id,
        useCurrentSeason: false
      }
    );

    if (error) {
      console.error("loadArchiveLogs error:", error);
      listEl.innerHTML = `<div class="muted">기록을 불러오지 못했습니다.</div>`;
      return;
    }

    if (!data || data.length === 0) {
      listEl.innerHTML = `<div class="muted">표시할 기록이 없습니다.</div>`;
      return;
    }

    listEl.innerHTML = "";
    data.forEach(row => listEl.appendChild(renderLogCard(row, { scope: "club", nameMap, isArchive: true })));
  }

  // ====== DASHBOARD ======
  async function loadDashboard() {
    const container = $("dashboardContent");
    if (!container) return;
    container.textContent = "데이터를 불러오는 중...";

    try {
      const nameMap = await loadProfilesMap();

      let q = supabase.from("reading_logs")
        .select("user_id,date")
        .eq("book_title", currentBookTitle)
        .eq("archived", false)
        .order("date", { ascending: false })
        .limit(1000);

      if (seasonIdOrNull()) q = q.eq("season_id", seasonIdOrNull());

      const { data, error } = await q;
      if (error) {
        console.error("dashboard logs error:", error);
        container.textContent = "대시보드 데이터를 불러오지 못했습니다.";
        return;
      }
      if (!data || data.length === 0) {
        container.textContent = "아직 기록된 데이터가 없습니다.";
        return;
      }

      const todayStr = todayISO();
      const todayDate = new Date(todayStr);
      const sevenAgo = new Date(todayDate.getTime() - 6*24*60*60*1000);

      const todayUsers = new Set();
      const last7Users = new Set();
      const allUsers = new Set();
      const counts = {};

      data.forEach(r => {
        const uid = r.user_id;
        if (!uid) return;
        allUsers.add(uid);
        counts[uid] = (counts[uid] || 0) + 1;
        if (r.date === todayStr) todayUsers.add(uid);
        const d = new Date(r.date);
        if (d >= sevenAgo && d <= todayDate) last7Users.add(uid);
      });

      const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([uid,c])=>({ uid, name: nameMap[uid] || "멤버", c }));

      container.innerHTML = `
        <div class="logs-list" style="gap:.45rem;">
          <div class="log-item"><div class="log-head"><span>오늘 기록한 멤버</span><span class="pill">${todayUsers.size}</span></div></div>
          <div class="log-item"><div class="log-head"><span>최근 7일 기록한 멤버</span><span class="pill">${last7Users.size}</span></div></div>
          <div class="log-item"><div class="log-head"><span>총 기록 수</span><span class="pill">${data.length}</span></div></div>
          <div class="log-item"><div class="log-head"><span>참여 멤버 수</span><span class="pill">${allUsers.size}</span></div></div>
        </div>
        <div style="margin-top:.8rem;">
          <div class="subtitle" style="margin-bottom:.35rem;">가장 활발한 멤버</div>
          ${top.length ? `<ul class="mini-list">${top.map(x=>`<li>${escapeHtml(x.name)} – ${x.c}회</li>`).join("")}</ul>` : `<div class="muted">데이터가 충분하지 않습니다.</div>`}
        </div>
      `;
    } catch (e) {
      console.error("loadDashboard exception:", e);
      container.textContent = "대시보드 데이터를 불러오지 못했습니다.";
    }
  }

  // ====== ADMIN ======
  function fillAdminForms() {
    $("settingBookTitleInput").value = currentBookTitle || DEFAULT_BOOK_TITLE;
    $("settingSeasonIdInput").value = currentSeason?.id || "";
    $("settingSeasonNameInput").value = currentSeason?.name || "";
    $("settingSeasonStartInput").value = currentSeason?.start || "";
    $("settingSeasonEndInput").value = currentSeason?.end || "";
  }

  async function saveClubSettings() {
    const statusEl = $("settingsStatus");
    statusEl.textContent = "저장 중...";

    const newBookTitle = ($("settingBookTitleInput").value || "").trim() || DEFAULT_BOOK_TITLE;
    const seasonId = ($("settingSeasonIdInput").value || "").trim();
    const seasonName = ($("settingSeasonNameInput").value || "").trim();
    const seasonStart = ($("settingSeasonStartInput").value || "").trim();
    const seasonEnd = ($("settingSeasonEndInput").value || "").trim();

    const updates = [
      { key: "current_book", value: { title: newBookTitle } }
    ];

    if (seasonId || seasonName || (seasonStart && seasonEnd)) {
      updates.push({
        key: "season",
        value: {
          id: seasonId || "",
          name: seasonName || "",
          start: seasonStart || "",
          end: seasonEnd || ""
        }
      });
    }

    const { error } = await supabase.from("club_settings").upsert(updates, { onConflict: "key" });
    if (error) {
      console.error("saveClubSettings error:", error);
      statusEl.textContent = "저장 실패";
      return;
    }

    statusEl.textContent = "저장 완료. 새 시즌이 설정되었습니다. 이전 기록은 아카이브 탭에서 확인할 수 있습니다.";
    currentBookTitle = newBookTitle;
    currentSeason = updates.find(u => u.key === "season")?.value || null;

    await loadClubSettings();
    renderApp();
  }

  async function addAdminUser() {
    const statusEl = $("adminStatus");
    const uid = ($("adminUserIdInput").value || "").trim();
    if (!uid) { statusEl.textContent = "user_id를 입력해 주세요."; return; }

    statusEl.textContent = "추가 중...";
    const { error } = await supabase.from("admin_users").insert({ user_id: uid });
    if (error) {
      console.error("addAdminUser error:", error);
      statusEl.textContent = "추가 실패 (이미 존재하거나 권한/RLS 확인)";
      return;
    }
    statusEl.textContent = "추가 완료";
    $("adminUserIdInput").value = "";
    loadAdminList();
  }

  async function loadAdminList() {
    const el = $("adminList");
    if (!el) return;
    el.innerHTML = `<div class="muted">불러오는 중...</div>`;
    try {
      const { data, error } = await supabase.from("admin_users").select("user_id").order("user_id", { ascending:true });
      if (error) {
        console.error("loadAdminList error:", error);
        el.innerHTML = `<div class="muted">관리자 목록을 불러오지 못했습니다.</div>`;
        return;
      }
      if (!data || data.length === 0) {
        el.innerHTML = `<div class="muted">등록된 관리자가 없습니다.</div>`;
        return;
      }
      el.innerHTML = "";
      data.forEach(r => {
        const d = document.createElement("div");
        d.className = "log-item";
        d.innerHTML = `<div class="log-head"><span>${escapeHtml(r.user_id)}</span><span class="pill">admin</span></div>`;
        el.appendChild(d);
      });
    } catch (e) {
      el.innerHTML = `<div class="muted">관리자 목록을 불러오지 못했습니다.</div>`;
    }
  }

  // ====== BOOT ======
  async function boot() {
    wireModalEvents();
    await loadClubSettings();

    const session = await getSession();
    if (!session || !session.user) {
      renderLogin();
      return;
    }

    sessionUser = session.user;

    await ensureProfile(sessionUser);
    await checkAdmin(sessionUser);

    renderUserArea();
    renderApp();
    appBooted = true;
  }

  // Handle auth changes
  supabase.auth.onAuthStateChange((event, session) => {
  if (event === "SIGNED_IN" && session?.user) {
    if (appBooted) {
      console.warn("Auth event ignored: app already booted");
      return;
    }
    boot();
    }

    if (event === "SIGNED_OUT") {
        appBooted = false;
        renderLogin();
    }
   });

  boot();
})();</script>
</body>
</html>
